# Makefile for Wirepas C Mesh API example

# Toolchain
CC  := gcc
AS  := as
LD  := ld
AR  := ar

# Paths, including trailing path separator
SOURCEPREFIX   := ./
BUILDPREFIX    := build/

# This example needs the mesh lib
MESH_LIB_FOLDER := ../../../lib/
MESH_LIB := $(MESH_LIB_FOLDER)build/mesh_api_lib.a

# General compiler flags
CFLAGS  := -std=gnu99 -Wall -Werror -Wenum-conversion

# Targets definition
MAIN_APP := gw-example

TARGET_APP := $(BUILDPREFIX)$(MAIN_APP)

# Add Api header
CFLAGS  += -I$(MESH_LIB_FOLDER)api
# Add platform api too
CFLAGS  += -I$(MESH_LIB_FOLDER)platform
# Add pthtread lib as needed by Mesh Lib
LDFLAGS += -pthread
# Add paho shared library
LDFLAGS += -lpaho-mqtt3cs

# Add Reentrant flag as using pthread
CFLAGS  += -D_REENTRANT

# Specific sources for main
SOURCES:= $(SOURCEPREFIX)main.c
SOURCES+= $(SOURCEPREFIX)meter_hook.c

OBJECTS := $(patsubst $(SOURCEPREFIX)%,                     \
                  $(BUILDPREFIX)%,                          \
                  $(SOURCES:.c=.o))

# Functions

# Also create the target directory if it does not exist
define COMPILE
	echo "  CC $(2)"
	mkdir -p $(dir $(1))
	$(CC) $(CFLAGS) -c -o $(1) $(2)
endef

define LINK
	echo "  Linking $(1)"
	$(CC) $(CFLAGS) -o $(1) $(2) $(MESH_LIB) $(LDFLAGS)
endef

define CLEAN
	echo "  Cleaning up"
	$(RM) -r $(BUILDPREFIX)
endef

# Target rules

# Use dependency files automatically generated by GCC.
# First collect all C source files
AUTODEPS := $(patsubst $(SOURCEPREFIX)%.c, $(BUILDPREFIX)%.d, $(SOURCES))

ifeq ($(V),1)
# "V=1" on command line, print commands.
else
# Default, do not print commands.
.SILENT:
endif

.PHONY: all
all: app

app: $(TARGET_APP)

.PHONY: clean
clean:
	$(call CLEAN)
	make -C $(MESH_LIB_FOLDER) clean

$(MESH_LIB): FORCE
	make -C $(MESH_LIB_FOLDER) proto_api_support=yes

$(BUILDPREFIX)%.o: $(SOURCEPREFIX)%.c
	$(call COMPILE,$@,$<)

$(BUILDPREFIX)$(MAIN_APP): $(OBJECTS) $(MESH_LIB)
	$(call LINK,$@,$^)

# Special rule to force other rule to run every time
FORCE:
